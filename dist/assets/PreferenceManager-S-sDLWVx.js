import{D as l}from"./index-BAmibXcC.js";import"./ui-g5Md-TqO.js";import"./vendor-kq2j8kjo.js";import"./supabase-CHvu9mtl.js";class u{static instance;preferenceManager=null;config;isPreloading=!1;preloadPromise=null;lastPreloadTime=0;preloadTimeout=null;constructor(e={}){this.config={preloadCritical:!0,preloadFull:!1,preloadOnAppStart:!0,preloadOnAuth:!0,preloadOnFocus:!1,preloadTimeout:5e3,...e}}static getInstance(e){return u.instance||(u.instance=new u(e)),u.instance}initialize(e){this.preferenceManager=c.getInstance(e)}async preloadCritical(){if(!this.preferenceManager)throw new Error("PreferencePreloader not initialized");const e=performance.now();try{console.log("üöÄ Preloading critical preferences..."),this.preferenceManager.getCriticalPreferences();const t=performance.now()-e;return console.log(`‚úÖ Critical preferences preloaded in ${t.toFixed(2)}ms`),this.lastPreloadTime=Date.now(),{success:!0,criticalLoaded:!0,fullLoaded:!1,duration:t}}catch(t){const r=performance.now()-e;return console.error("‚ùå Failed to preload critical preferences:",t),{success:!1,criticalLoaded:!1,fullLoaded:!1,duration:r,error:t instanceof Error?t.message:"Unknown error"}}}async preloadFull(){if(!this.preferenceManager)throw new Error("PreferencePreloader not initialized");const e=performance.now();try{console.log("üîÑ Preloading full preferences..."),await this.preferenceManager.getPreferences();const t=performance.now()-e;return console.log(`‚úÖ Full preferences preloaded in ${t.toFixed(2)}ms`),this.lastPreloadTime=Date.now(),{success:!0,criticalLoaded:!0,fullLoaded:!0,duration:t}}catch(t){const r=performance.now()-e;return console.error("‚ùå Failed to preload full preferences:",t),{success:!1,criticalLoaded:!1,fullLoaded:!1,duration:r,error:t instanceof Error?t.message:"Unknown error"}}}async preload(){if(this.isPreloading&&this.preloadPromise)return console.log("‚è≥ Preload already in progress, waiting..."),this.preloadPromise;this.isPreloading=!0,this.preloadTimeout=setTimeout(()=>{console.warn("‚ö†Ô∏è Preference preload timeout reached"),this.isPreloading=!1},this.config.preloadTimeout);try{const e=await this.preloadCritical();return e.success&&this.config.preloadFull?await this.preloadFull():e}finally{this.isPreloading=!1,this.preloadTimeout&&(clearTimeout(this.preloadTimeout),this.preloadTimeout=null)}}async preloadOnAppStart(){return this.config.preloadOnAppStart?(console.log("üöÄ Preloading preferences on app start..."),this.preload()):(console.log("‚è≠Ô∏è App start preload disabled"),{success:!0,criticalLoaded:!1,fullLoaded:!1,duration:0})}async preloadOnAuth(){return this.config.preloadOnAuth?(console.log("üîê Preloading preferences on authentication..."),this.preload()):(console.log("‚è≠Ô∏è Auth preload disabled"),{success:!0,criticalLoaded:!1,fullLoaded:!1,duration:0})}async preloadOnFocus(){return this.config.preloadOnFocus?Date.now()-this.lastPreloadTime<300*1e3?(console.log("‚è≠Ô∏è Skipping focus preload (too recent)"),{success:!0,criticalLoaded:!0,fullLoaded:!0,duration:0}):(console.log("üì± Preloading preferences on app focus..."),this.preload()):(console.log("‚è≠Ô∏è Focus preload disabled"),{success:!0,criticalLoaded:!1,fullLoaded:!1,duration:0})}getStatus(){return{isPreloading:this.isPreloading,lastPreloadTime:this.lastPreloadTime,timeSinceLastPreload:Date.now()-this.lastPreloadTime,config:this.config}}updateConfig(e){this.config={...this.config,...e},console.log("‚öôÔ∏è Updated preload configuration:",this.config)}reset(){this.isPreloading=!1,this.preloadPromise=null,this.lastPreloadTime=0,this.preloadTimeout&&(clearTimeout(this.preloadTimeout),this.preloadTimeout=null),console.log("üîÑ Preference preloader reset")}}class p{cache=new Map;strategy;stats={hits:0,misses:0,evictions:0,totalAccesses:0};constructor(e){this.strategy={critical:{ttl:1440*60*1e3,priority:"high",preload:!0,maxSize:1024*1024},nonCritical:{ttl:3600*1e3,priority:"medium",preload:!1,maxSize:512*1024},validation:{ttl:1800*1e3,priority:"low",preload:!1,maxSize:256*1024},...e}}get(e,t="nonCritical"){this.stats.totalAccesses++,performance.now();const r=this.cache.get(e);if(!r)return this.stats.misses++,null;const i=Date.now();return i-r.timestamp>r.ttl?(this.cache.delete(e),this.stats.misses++,null):(r.accessCount++,r.lastAccess=i,this.stats.hits++,r.data)}set(e,t,r="nonCritical",i){const s=this.strategy[r],a=this.calculateSize(t);this.ensureCapacity(r,a);const n={data:t,timestamp:Date.now(),ttl:i||s.ttl,priority:s.priority,accessCount:0,lastAccess:Date.now(),size:a};this.cache.set(e,n)}getCriticalPreferences(){return this.get("critical_preferences","critical")}setCriticalPreferences(e){this.set("critical_preferences",e,"critical")}getFullPreferences(){return this.get("full_preferences","nonCritical")}setFullPreferences(e){this.set("full_preferences",e,"nonCritical")}getValidationResult(e){return this.get(`validation_${e}`,"validation")}setValidationResult(e,t){this.set(`validation_${e}`,t,"validation")}has(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp<=t.ttl:!1}delete(e){return this.cache.delete(e)}clear(){this.cache.clear(),this.resetStats()}clearExpired(){const e=Date.now();let t=0;for(const[r,i]of this.cache.entries())e-i.timestamp>i.ttl&&(this.cache.delete(r),t++);return t}getStats(){const e=this.cache.size;let t=0,r=0;for(const n of this.cache.values())t+=n.size,r+=n.accessCount;const i=this.stats.totalAccesses>0?this.stats.hits/this.stats.totalAccesses:0,s=this.stats.totalAccesses>0?this.stats.misses/this.stats.totalAccesses:0,a=e>0?r/e:0;return{totalEntries:e,totalSize:t,hitRate:i,missRate:s,evictions:this.stats.evictions,averageAccessTime:a,memoryUsage:this.getMemoryUsage()}}updateStrategy(e){this.strategy={...this.strategy,...e}}getEntriesByType(e){const t=[];for(const[r,i]of this.cache.entries())i.priority===this.strategy[e].priority&&t.push({key:r,entry:i});return t}ensureCapacity(e,t){this.strategy[e];const r=this.getEntriesByType(e);let i=0;for(const{entry:s}of r)i+=s.size;i+t>this.strategy[e].maxSize&&this.evictEntries(e,t)}evictEntries(e,t){this.strategy[e];const r=this.getEntriesByType(e);r.sort((a,n)=>a.entry.lastAccess-n.entry.lastAccess);let i=0;const s=[];for(const{key:a,entry:n}of r){if(i>=t)break;s.push(a),i+=n.size}for(const a of s)this.cache.delete(a),this.stats.evictions++}calculateSize(e){try{return new Blob([JSON.stringify(e)]).size}catch{return 1024}}getMemoryUsage(){let e=0;for(const t of this.cache.values())e+=t.size;return e}resetStats(){this.stats={hits:0,misses:0,evictions:0,totalAccesses:0}}}class w{static baseURL="/api/preferences";static async validate(e){try{const t=await fetch(`${this.baseURL}/validate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Validation failed: ${t.statusText}`);return await t.json()}catch(t){return console.error("Server validation failed, falling back to client validation:",t),this.clientSideValidation(e.preferences,e.validationLevel)}}static async validateCritical(e){return this.validate({preferences:e,validationLevel:"critical"})}static async validateStrict(e){return this.validate({preferences:e,validationLevel:"strict"})}static clientSideValidation(e,t){const r=[],i=[],s=[],a=[],n=this.getValidationRules(t);for(const o of n){const h=e[o.field],d=o.validator(h);d.isValid?d.warning&&i.push(d.warning):o.critical?(r.push(d.error||`Invalid ${o.field}`),s.push(o.field)):i.push(d.error||`Invalid ${o.field}`)}if(t==="strict"||t==="relaxed"){const o=this.validateLogic(e);r.push(...o.errors),i.push(...o.warnings),a.push(...o.suggestions)}return{isValid:r.length===0,errors:r,warnings:i,criticalFields:s,suggestions:a,validationLevel:t,timestamp:new Date().toISOString()}}static getValidationRules(e){const t=[{field:"calendar_work_start",required:!0,critical:!0,validator:r=>r?this.isValidTimeFormat(r)?{isValid:!0}:{isValid:!1,error:"Invalid time format (use HH:MM or HH:MM:SS)"}:{isValid:!1,error:"Work start time is required"}},{field:"calendar_work_end",required:!0,critical:!0,validator:r=>r?this.isValidTimeFormat(r)?{isValid:!0}:{isValid:!1,error:"Invalid time format (use HH:MM or HH:MM:SS)"}:{isValid:!1,error:"Work end time is required"}},{field:"calendar_working_days",required:!0,critical:!0,validator:r=>!Array.isArray(r)||r.length===0?{isValid:!1,error:"Working days must be a non-empty array"}:{isValid:!0}},{field:"calendar_min_gap",required:!1,critical:!1,validator:r=>r!==void 0&&(typeof r!="number"||r<5)?{isValid:!1,error:"Minimum gap must be at least 5 minutes"}:{isValid:!0}}];return e==="strict"&&t.push({field:"preferred_categories",required:!1,critical:!1,validator:r=>r&&(!Array.isArray(r)||r.length===0)?{isValid:!1,error:"Preferred categories must be a non-empty array"}:{isValid:!0}}),t}static validateLogic(e){const t=[],r=[],i=[];if(e.calendar_work_start&&e.calendar_work_end){const s=this.timeToMinutes(e.calendar_work_start),a=this.timeToMinutes(e.calendar_work_end);s>=a&&t.push("Work start time must be before work end time"),a-s<60&&(r.push("Work hours are less than 1 hour"),i.push("Consider extending your work hours for better productivity")),a-s>720&&(r.push("Work hours are more than 12 hours"),i.push("Consider shorter work hours for better work-life balance"))}return e.calendar_working_days&&e.calendar_working_days.length===0&&t.push("At least one working day must be selected"),{errors:t,warnings:r,suggestions:i}}static isValidTimeFormat(e){return/^([0-1]?[0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?$/.test(e)}static timeToMinutes(e){const[t,r]=e.split(":").map(Number);return t*60+(r||0)}}class f{static instance;impactConfig;constructor(){this.impactConfig={critical:{fields:["calendar_work_start","calendar_work_end","calendar_working_days"],impact:"high",requiresGapRecalculation:!0,requiresImmediateUpdate:!0},medium:{fields:["calendar_min_gap","calendar_buffer_time"],impact:"medium",requiresGapRecalculation:!0,requiresImmediateUpdate:!1},low:{fields:["dark_mode","sound_enabled","vibration_enabled","default_energy_level","preferred_categories","autostart","show_timer"],impact:"low",requiresGapRecalculation:!1,requiresImmediateUpdate:!1}}}static getInstance(){return f.instance||(f.instance=new f),f.instance}detectChanges(e,t){const r=[];let i=!1,s=!1;for(const o of Object.keys(t)){const h=e[o],d=t[o];if(!this.isEqual(h,d)){const g=this.createChangeEvent(o,h,d);r.push(g),g.requiresGapRecalculation&&(i=!0),g.requiresImmediateUpdate&&(s=!0)}}const a=this.calculateAffectedDateRange(r),n=this.generateSummary(r);return{hasChanges:r.length>0,changes:r,requiresGapRecalculation:i,requiresImmediateUpdate:s,summary:n,affectedDateRange:a}}createChangeEvent(e,t,r){const i=this.getFieldImpact(e),s=this.impactConfig[i];return{field:e,oldValue:t,newValue:r,impact:s.impact,requiresGapRecalculation:s.requiresGapRecalculation,requiresImmediateUpdate:s.requiresImmediateUpdate,affectedDates:this.getAffectedDates(e,t,r),description:this.generateChangeDescription(e,t,r)}}getFieldImpact(e){return this.impactConfig.critical.fields.includes(e)?"critical":this.impactConfig.medium.fields.includes(e)?"medium":"low"}calculateAffectedDateRange(e){if(e.filter(a=>a.requiresGapRecalculation&&a.impact==="high").length===0)return null;const r=new Date,i=r.toLocaleDateString("en-CA"),s=new Date(r.getTime()+336*60*60*1e3).toLocaleDateString("en-CA");return{start:i,end:s}}getAffectedDates(e,t,r){const i=[],s=new Date;if(e==="calendar_working_days")for(let a=0;a<14;a++){const n=new Date(s.getTime()+a*24*60*60*1e3);i.push(n.toLocaleDateString("en-CA"))}else if(e==="calendar_work_start"||e==="calendar_work_end")for(let a=0;a<14;a++){const n=new Date(s.getTime()+a*24*60*60*1e3);i.push(n.toLocaleDateString("en-CA"))}else{i.push(s.toLocaleDateString("en-CA"));const a=new Date(s.getTime()+1440*60*1e3);i.push(a.toLocaleDateString("en-CA"))}return i}generateChangeDescription(e,t,r){switch(e){case"calendar_work_start":return`Work start time changed from ${t} to ${r}`;case"calendar_work_end":return`Work end time changed from ${t} to ${r}`;case"calendar_working_days":return`Working days changed from ${t?.join(", ")} to ${r?.join(", ")}`;case"calendar_min_gap":return`Minimum gap changed from ${t} to ${r} minutes`;case"dark_mode":return`Dark mode changed from ${t} to ${r}`;default:return`${e} changed from ${t} to ${r}`}}generateSummary(e){if(e.length===0)return"No changes detected";const t=e.filter(a=>a.impact==="high"),r=e.filter(a=>a.impact==="medium"),i=e.filter(a=>a.impact==="low"),s=[];return t.length>0&&s.push(`${t.length} critical change${t.length>1?"s":""}`),r.length>0&&s.push(`${r.length} medium change${r.length>1?"s":""}`),i.length>0&&s.push(`${i.length} minor change${i.length>1?"s":""}`),s.join(", ")}isEqual(e,t){if(e===t)return!0;if(e==null||t==null||typeof e!=typeof t)return!1;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!this.isEqual(e[r],t[r]))return!1;return!0}if(typeof e=="object"){const r=Object.keys(e),i=Object.keys(t);if(r.length!==i.length)return!1;for(const s of r)if(!i.includes(s)||!this.isEqual(e[s],t[s]))return!1;return!0}return!1}updateImpactConfig(e){this.impactConfig={...this.impactConfig,...e}}getImpactConfig(){return{...this.impactConfig}}requiresGapRecalculation(e){const t=this.getFieldImpact(e);return this.impactConfig[t].requiresGapRecalculation}requiresImmediateUpdate(e){const t=this.getFieldImpact(e);return this.impactConfig[t].requiresImmediateUpdate}}class c{static instance;preferences=null;isLoading=!1;lastLoadTime=0;config;storage;preloader;intelligentCache;changeDetector;constructor(e,t={}){this.storage=e,this.config={memoryTTL:1440*60*1e3,validationEnabled:!0,criticalFields:["calendar_work_start","calendar_work_end","calendar_working_days","calendar_min_gap"],defaultFallback:!0,enablePreloading:!0,enableIntelligentCache:!0,enableChangeDetection:!0,enableServerValidation:!0,...t},this.config.enableIntelligentCache&&(this.intelligentCache=new p),this.config.enableChangeDetection&&(this.changeDetector=f.getInstance())}static getInstance(e,t){return c.instance||(c.instance=new c(e,t),c.instance.config.enablePreloading&&(c.instance.preloader=u.getInstance(),c.instance.preloader.initialize(e))),c.instance}async getPreferences(){const e=Date.now();if(this.intelligentCache){const t=this.intelligentCache.getFullPreferences();if(t)return console.log("‚ö° Preferences retrieved from intelligent cache"),t}if(this.preferences&&e-this.lastLoadTime<this.config.memoryTTL)return console.log("‚ö° Preferences retrieved from memory cache"),this.preferences;if(this.isLoading){for(console.log("‚è≥ Preferences already loading, waiting...");this.isLoading;)await new Promise(t=>setTimeout(t,10));return this.preferences||l}this.isLoading=!0;try{console.log("üîÑ Loading preferences...");let t=await this.loadFromStorage();if(t||(t=await this.loadFromServer()),!t&&this.config.defaultFallback&&(t=l,console.log("‚ö†Ô∏è Using default preferences")),t){if(this.config.enableServerValidation)try{const r=await w.validateStrict(t);r.isValid||(console.warn("‚ö†Ô∏è Server validation failed:",r.errors),this.config.defaultFallback&&(t=this.mergeWithDefaults(t)))}catch(r){console.warn("‚ö†Ô∏è Server validation failed, using client validation:",r);const i=this.validatePreferences(t);i.isValid||(console.warn("‚ö†Ô∏è Client validation failed:",i.errors),this.config.defaultFallback&&(t=this.mergeWithDefaults(t)))}else{const r=this.validatePreferences(t);r.isValid||(console.warn("‚ö†Ô∏è Preference validation failed:",r.errors),this.config.defaultFallback&&(t=this.mergeWithDefaults(t)))}return this.preferences=t,this.lastLoadTime=e,this.intelligentCache&&this.intelligentCache.setFullPreferences(t),await this.saveToStorage(t),console.log("‚úÖ Preferences loaded successfully"),t}throw new Error("Failed to load preferences from all sources")}catch(t){if(console.error("‚ùå Error loading preferences:",t),this.config.defaultFallback)return l;throw t}finally{this.isLoading=!1}}async savePreferences(e){if(console.log("üíæ Saving preferences..."),this.changeDetector&&this.preferences){const t=this.changeDetector.detectChanges(this.preferences,e);t.hasChanges&&(console.log("üîÑ Preference changes detected:",t.summary),t.requiresGapRecalculation&&(console.log("‚ö†Ô∏è Gap recalculation required for affected dates:",t.affectedDateRange),this.emitPreferenceChangeEvent(t)))}this.intelligentCache&&this.intelligentCache.setFullPreferences(e),this.preferences=e,this.lastLoadTime=Date.now(),await this.saveToStorage(e),this.syncToServer(e).catch(t=>{console.warn("‚ö†Ô∏è Background server sync failed:",t)}),console.log("‚úÖ Preferences saved successfully")}getCriticalPreferences(){if(this.intelligentCache){const t=this.intelligentCache.getCriticalPreferences();if(t)return t}if(!this.preferences){const t={calendar_work_start:l.calendar_work_start,calendar_work_end:l.calendar_work_end,calendar_working_days:l.calendar_working_days,calendar_min_gap:l.calendar_min_gap};return this.intelligentCache&&this.intelligentCache.setCriticalPreferences(t),t}const e=this.config.criticalFields.reduce((t,r)=>{const i=this.preferences[r];return i!==void 0&&(t[r]=i),t},{});return this.intelligentCache&&this.intelligentCache.setCriticalPreferences(e),e}isLoaded(){return this.preferences!==null&&Date.now()-this.lastLoadTime<this.config.memoryTTL}async refresh(){return console.log("üîÑ Force refreshing preferences..."),this.preferences=null,this.lastLoadTime=0,this.getPreferences()}clearCache(){this.preferences=null,this.lastLoadTime=0,this.intelligentCache&&this.intelligentCache.clear(),console.log("üóëÔ∏è Preference cache cleared")}async preloadCritical(){this.preloader&&await this.preloader.preloadCritical()}async preloadFull(){this.preloader&&await this.preloader.preloadFull()}getCacheStats(){return this.intelligentCache?this.intelligentCache.getStats():null}getPreloadStatus(){return this.preloader?this.preloader.getStatus():null}emitPreferenceChangeEvent(e){console.log("üì° Preference change event emitted:",{requiresGapRecalculation:e.requiresGapRecalculation,affectedDateRange:e.affectedDateRange,changes:e.changes}),typeof window<"u"&&window.dispatchEvent(new CustomEvent("preferenceChange",{detail:e}))}validatePreferences(e){const t=[],r=[],i=[];for(const a of this.config.criticalFields){const n=e[a];(n==null||n==="")&&(t.push(`Missing critical field: ${a}`),i.push(a))}if(e.calendar_work_start&&e.calendar_work_end){const a=this.timeToMinutes(e.calendar_work_start),n=this.timeToMinutes(e.calendar_work_end);a>=n&&t.push("Work start time must be before work end time"),n-a<60&&r.push("Work hours are less than 1 hour")}e.calendar_working_days&&(!Array.isArray(e.calendar_working_days)||e.calendar_working_days.length===0)&&t.push("Working days must be a non-empty array");const s=["calendar_work_start","calendar_work_end"];for(const a of s){const n=e[a];n&&typeof n=="string"&&!this.isValidTimeFormat(n)&&r.push(`Invalid time format for ${a}: ${n}`)}return{isValid:t.length===0,errors:t,warnings:r,criticalFields:i}}mergeWithDefaults(e){return{...l,...e,calendar_work_start:e.calendar_work_start||l.calendar_work_start,calendar_work_end:e.calendar_work_end||l.calendar_work_end,calendar_working_days:e.calendar_working_days||l.calendar_working_days,calendar_min_gap:e.calendar_min_gap||l.calendar_min_gap}}async loadFromStorage(){try{return await this.storage.getPreferences()}catch(e){return console.warn("‚ö†Ô∏è Failed to load preferences from storage:",e),null}}async loadFromServer(){try{return null}catch(e){return console.warn("‚ö†Ô∏è Failed to load preferences from server:",e),null}}async saveToStorage(e){try{await this.storage.savePreferences(e)}catch(t){throw console.error("‚ùå Failed to save preferences to storage:",t),t}}async syncToServer(e){}timeToMinutes(e){const[t,r]=e.split(":").map(Number);return t*60+(r||0)}isValidTimeFormat(e){return/^([0-1]?[0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?$/.test(e)}}export{c as PreferenceManager};
//# sourceMappingURL=PreferenceManager-S-sDLWVx.js.map
