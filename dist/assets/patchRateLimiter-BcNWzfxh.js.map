{"version":3,"file":"patchRateLimiter-BcNWzfxh.js","sources":["../../utils/storage/patchRateLimiter.ts"],"sourcesContent":["/**\n * Token-bucket rate limiter for preference PATCH calls.\n * - Refill: 1 token every 1500ms\n * - Capacity: 3 tokens (burst)\n */\nclass PatchRateLimiter {\n  private capacity: number;\n  private tokens: number;\n  private refillIntervalMs: number;\n  private lastRefill: number;\n\n  constructor(capacity = 3, refillIntervalMs = 1500) {\n    this.capacity = capacity;\n    this.tokens = capacity;\n    this.refillIntervalMs = refillIntervalMs;\n    this.lastRefill = Date.now();\n  }\n\n  private refill() {\n    const now = Date.now();\n    const elapsed = now - this.lastRefill;\n    if (elapsed <= 0) return;\n    const tokensToAdd = Math.floor(elapsed / this.refillIntervalMs);\n    if (tokensToAdd > 0) {\n      this.tokens = Math.min(this.capacity, this.tokens + tokensToAdd);\n      this.lastRefill = now;\n    }\n  }\n\n  consumeToken(): boolean {\n    this.refill();\n    if (this.tokens > 0) {\n      this.tokens -= 1;\n      return true;\n    }\n    return false;\n  }\n\n  // Test-only: reset the limiter to full capacity\n  resetForTests(): void {\n    this.tokens = this.capacity;\n    this.lastRefill = Date.now();\n  }\n}\n\n// Singleton per tab\nconst globalLimiter = new PatchRateLimiter();\n\nexport function consumePatchToken(): boolean {\n  return globalLimiter.consumeToken();\n}\n\n// Test-only utility to reset the singleton limiter between tests\nexport function __resetPatchLimiterForTests() {\n  globalLimiter.resetForTests();\n}\n\n\n"],"names":["PatchRateLimiter","capacity","refillIntervalMs","now","elapsed","tokensToAdd","globalLimiter","consumePatchToken"],"mappings":"AAKA,MAAMA,CAAiB,CACb,SACA,OACA,iBACA,WAER,YAAYC,EAAW,EAAGC,EAAmB,KAAM,CACjD,KAAK,SAAWD,EAChB,KAAK,OAASA,EACd,KAAK,iBAAmBC,EACxB,KAAK,WAAa,KAAK,IAAA,CACzB,CAEQ,QAAS,CACf,MAAMC,EAAM,KAAK,IAAA,EACXC,EAAUD,EAAM,KAAK,WAC3B,GAAIC,GAAW,EAAG,OAClB,MAAMC,EAAc,KAAK,MAAMD,EAAU,KAAK,gBAAgB,EAC1DC,EAAc,IAChB,KAAK,OAAS,KAAK,IAAI,KAAK,SAAU,KAAK,OAASA,CAAW,EAC/D,KAAK,WAAaF,EAEtB,CAEA,cAAwB,CAEtB,OADA,KAAK,OAAA,EACD,KAAK,OAAS,GAChB,KAAK,QAAU,EACR,IAEF,EACT,CAGA,eAAsB,CACpB,KAAK,OAAS,KAAK,SACnB,KAAK,WAAa,KAAK,IAAA,CACzB,CACF,CAGA,MAAMG,EAAgB,IAAIN,EAEnB,SAASO,GAA6B,CAC3C,OAAOD,EAAc,aAAA,CACvB"}